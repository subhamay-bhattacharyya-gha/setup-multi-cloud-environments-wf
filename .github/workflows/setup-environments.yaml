name: Setup Multi-Cloud Environments
run-name: Setup Multi-Cloud Environments by ${{ github.actor }}

on:
  workflow_call:
    inputs:
      ci-environment:
        description: "CI environment name"
        required: true
        type: string
      aws-region:
        description: "AWS region where services will be deployed"
        required: true
        type: string
      gcp-region:
        description: "GCP region where services will be deployed"
        required: true
        type: string
      azure-region:
        description: "Azure region where services will be deployed"
        required: true
        type: string
    secrets:
      GH_PAT:
        description: "GitHub Personal Access Token with repo, workflow, and admin:repo_hook scopes"
        required: true

permissions:
  contents: write
  id-token: write
  actions: write
  deployments: write

jobs:

  setup-environments:
    name: Bootstrap Environments
    runs-on: ubuntu-latest

    steps:
      - name: Print Input Variables
        shell: bash
        run: |
          echo "## Input Variables" >> $GITHUB_STEP_SUMMARY
          echo "- **CI Environment**: ${{ inputs.ci-environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ inputs.aws-region }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GCP Region**: ${{ inputs.gcp-region }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Azure Region**: ${{ inputs.azure-region }}" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "Input Variables:"
          echo "  CI Environment: ${{ inputs.ci-environment }}"
          echo "  AWS Region: ${{ inputs.aws-region }}"
          echo "  GCP Region: ${{ inputs.gcp-region }}"
          echo "  Azure Region: ${{ inputs.azure-region }}"

      ## Git checkout is needed here for the workflow to run in the context of the repository.
      ## This is required to ensure that the workflow has access to the repository context.
      - name: Checkout repository
        uses: actions/checkout@v4

      # - name: Add CODEOWNERS as collaborators
      #   env:
      #     GH_TOKEN: ${{ secrets.GH_PAT }}
      #   run: |
      #     set -euo pipefail

      #     echo "::group::Parsing CODEOWNERS and adding collaborators"

      #     # Extract GitHub usernames and teams from CODEOWNERS
      #     owners=$(grep -v '^#' CODEOWNERS | awk '{$1=""; print $0}' | tr -s ' ' '\n' | grep '^@' | sort -u)

      #     for owner in $owners; do
      #       echo "Processing owner: $owner"

      #       if [[ "$owner" =~ ^@([a-zA-Z0-9._-]+)$ ]]; then
      #         username="${BASH_REMATCH[1]}"
      #         echo "Adding user: $username"
      #         gh api --method PUT "/repos/${GITHUB_REPOSITORY}/collaborators/$username" \
      #           -f permission='push' || echo "Failed to add $username â€” skipping."
      #       elif [[ "$owner" =~ ^@([a-zA-Z0-9._-]+)/([a-zA-Z0-9._-]+)$ ]]; then
      #         org="${BASH_REMATCH[1]}"
      #         team="${BASH_REMATCH[2]}"
      #         echo "Detected team: @${org}/${team}"
      #         gh api --method PUT "/orgs/${org}/teams/${team}/repos/${GITHUB_REPOSITORY}" \
      #           -f permission="push"
      #       else
      #         echo "âŒ Invalid CODEOWNERS entry: $owner"
      #       fi
      #     done

      #     echo "::endgroup::"

      - name: Delete all environments
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail

          echo "::group::Fetching environments"
          environments=$(gh api "/repos/${GITHUB_REPOSITORY}/environments" --jq '.environments[].name')
          echo "::endgroup::"

          for env in $environments; do
            echo "::group::Deleting environment: $env"
            gh api --method DELETE "/repos/${GITHUB_REPOSITORY}/environments/$env"
            echo "::endgroup::"
          done

      - name: Create environments with secrets and variables
        working-directory: ${{ github.workspace }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          CI_ACCOUNT: ${{ inputs.ci-environment }}
          AWS_REGION: ${{ inputs.aws-region}}
          GCP_REGION: ${{ inputs.gcp-region}}
          AZURE_REGION: ${{ inputs.azure-region}}
          # DEVL_ACCOUNT: ${{ inputs.devl-environment }}
          # TEST_ACCOUNT: ${{ inputs.test-environment }}
          # PROD_ACCOUNT: ${{ inputs.prod-environment }}
          # AWS_ACCOUNTS: ${{ vars.AWS_ACCOUNTS }}
          # AWS_OIDC_ROLE: ${{ vars.AWS_OIDC_ROLE }}
          # TF_STATE_BUCKET_BASE_NAME: ${{ vars.TF_STATE_BUCKET_BASE_NAME }}
          # S3_KMS_KEY_ALIAS: ${{ vars.S3_KMS_KEY_ALIAS }}
          # AWS_REGION: ${{ inputs.aws-region }}  # added for simpler reuse
          ORG_SHORT_NAME: ${{ vars.ORG_SHORT_NAME }}
        run: |
          set -euo pipefail

          echo "::group::Creating environments and setting secrets and variables"
          gh_env_name=gh_env_name="${ORG_SHORT_NAME}-aws-${AWS_REGION}"
          gh api --method PUT "repos/${GITHUB_REPOSITORY}/environments/$gh_env_name"

          gh_env_name=gh_env_name="${ORG_SHORT_NAME}-gcp-${AWS_REGION}"
          gh api --method PUT "repos/${GITHUB_REPOSITORY}/environments/$gh_env_name"

          gh_env_name=gh_env_name="${ORG_SHORT_NAME}-azure-${AWS_REGION}"
          gh api --method PUT "repos/${GITHUB_REPOSITORY}/environments/$gh_env_name"

          echo "::endgroup::"

      - name: Summary
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          AWS_REGION: ${{ inputs.aws-region }}
          GCP_REGION: ${{ inputs.gcp-region }}
          AZURE_REGION: ${{ inputs.azure-region }}
        run: |
          # Fetch ORG_SHORT_NAME from repository variables
          ORG_SHORT_NAME=$(gh variable get ORG_SHORT_NAME -R $REPO)
          
          # Create summary
          echo "## ðŸŽ‰ Multi-Cloud Environment Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environments Created:" >> $GITHUB_STEP_SUMMARY
          echo "- **CI**: ${{ inputs.ci-environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS**: ${ORG_SHORT_NAME}-aws-${AWS_REGION}" >> $GITHUB_STEP_SUMMARY
          echo "- **GCP**: ${ORG_SHORT_NAME}-gcp-${GCP_REGION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Azure**: ${ORG_SHORT_NAME}-azure-${AZURE_REGION}" >> $GITHUB_STEP_SUMMARY
